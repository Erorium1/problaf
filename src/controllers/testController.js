const fs = require('fs');
const path = require('path');

// Путь к файлу с результатами тестов
const TEST_RESULTS_PATH = path.join(__dirname, '../../data/test_results.json');

// Функция для загрузки результатов из файла
const loadTestResults = () => {
  try {
    const data = fs.readFileSync(TEST_RESULTS_PATH, 'utf8');
    return JSON.parse(data);
  } catch (error) {
    console.error('Error loading test results:', error);
    return { results: [] };
  }
};

// Функция для сохранения результатов в файл
const saveTestResultsToFile = (data) => {
  try {
    fs.writeFileSync(TEST_RESULTS_PATH, JSON.stringify(data, null, 2));
  } catch (error) {
    console.error('Error saving test results:', error);
    throw error;
  }
};

// Функция для расчета баллов блока
const calculateBlockScore = (block) => {
  const values = Object.values(block);
  return values.reduce((sum, value) => sum + value, 0);
};

// Функция для определения уровня на основе баллов
const determineLevel = (score) => {
  if (score >= 45) return 'Высокий уровень';
  if (score >= 35) return 'Выше среднего';
  if (score >= 25) return 'Средний уровень';
  if (score >= 15) return 'Ниже среднего';
  return 'Низкий уровень';
};

// Функция для получения описания уровня
const getLevelDescription = (category, level) => {
  const descriptions = {
    'Интеллектуальные способности': {
      'Высокий уровень': 'Вы обладаете отличными интеллектуальными способностями, склонны к аналитическому мышлению и решению сложных задач.',
      'Выше среднего': 'У вас хорошие интеллектуальные способности, вы можете успешно справляться с большинством интеллектуальных задач.',
      'Средний уровень': 'Ваши интеллектуальные способности находятся на среднем уровне, есть потенциал для развития.',
      'Ниже среднего': 'Вам может быть сложно с некоторыми интеллектуальными задачами, но при желании можно развить эти навыки.',
      'Низкий уровень': 'Вам может быть сложно с интеллектуальными задачами, рекомендуется развивать эти навыки.'
    },
    'Коммуникативные навыки': {
      'Высокий уровень': 'Вы отлично умеете общаться, находить общий язык с людьми и работать в команде.',
      'Выше среднего': 'У вас хорошие коммуникативные навыки, вы умеете эффективно общаться с окружающими.',
      'Средний уровень': 'Ваши коммуникативные навыки находятся на среднем уровне, есть потенциал для развития.',
      'Ниже среднего': 'Вам может быть сложно в общении, но при желании можно развить эти навыки.',
      'Низкий уровень': 'Вам может быть сложно в общении, рекомендуется развивать эти навыки.'
    },
    'Эмоциональный интеллект': {
      'Высокий уровень': 'Вы хорошо понимаете свои и чужие эмоции, умеете управлять ими и эффективно взаимодействовать с людьми.',
      'Выше среднего': 'У вас хороший эмоциональный интеллект, вы умеете понимать эмоции и управлять ими.',
      'Средний уровень': 'Ваш эмоциональный интеллект находится на среднем уровне, есть потенциал для развития.',
      'Ниже среднего': 'Вам может быть сложно понимать и управлять эмоциями, но при желании можно развить эти навыки.',
      'Низкий уровень': 'Вам может быть сложно понимать и управлять эмоциями, рекомендуется развивать эти навыки.'
    },
    'Профессиональные предпочтения': {
      'Высокий уровень': 'Вы четко понимаете свои профессиональные интересы и предпочтения, знаете, в каком направлении хотите развиваться.',
      'Выше среднего': 'У вас есть хорошее понимание своих профессиональных интересов и предпочтений.',
      'Средний уровень': 'Ваши профессиональные предпочтения находятся на стадии формирования, есть потенциал для развития.',
      'Ниже среднего': 'Вам может быть сложно определить свои профессиональные интересы, но при желании можно развить это понимание.',
      'Низкий уровень': 'Вам может быть сложно определить свои профессиональные интересы, рекомендуется развивать это понимание.'
    },
    'Личностные качества': {
      'Высокий уровень': 'Вы обладаете сильными личностными качествами, которые помогают вам достигать успеха в различных сферах.',
      'Выше среднего': 'У вас есть хорошие личностные качества, которые помогают вам в жизни и работе.',
      'Средний уровень': 'Ваши личностные качества находятся на среднем уровне, есть потенциал для развития.',
      'Ниже среднего': 'Вам может быть сложно проявлять некоторые личностные качества, но при желании можно их развить.',
      'Низкий уровень': 'Вам может быть сложно проявлять некоторые личностные качества, рекомендуется их развивать.'
    }
  };

  return descriptions[category]?.[level] || 'Нет описания';
};

// Функция для получения рекомендаций
const getAdvice = (category, level) => {
  const advice = {
    'Интеллектуальные способности': {
      'Высокий уровень': [
        'Продолжайте развивать аналитическое мышление',
        'Изучайте новые области знаний',
        'Участвуйте в интеллектуальных соревнованиях'
      ],
      'Выше среднего': [
        'Развивайте критическое мышление',
        'Изучайте новые предметы',
        'Практикуйте решение сложных задач'
      ],
      'Средний уровень': [
        'Читайте научную литературу',
        'Решайте логические задачи',
        'Изучайте новые методы анализа'
      ],
      'Ниже среднего': [
        'Начните с простых задач',
        'Читайте образовательную литературу',
        'Практикуйте базовые навыки'
      ],
      'Низкий уровень': [
        'Развивайте базовые навыки',
        'Начните с простых задач',
        'Ищите поддержку у преподавателей'
      ]
    },
    'Коммуникативные навыки': {
      'Высокий уровень': [
        'Развивайте навыки публичных выступлений',
        'Участвуйте в дебатах',
        'Практикуйте активное слушание'
      ],
      'Выше среднего': [
        'Работайте над невербальной коммуникацией',
        'Развивайте эмпатию',
        'Практикуйте конструктивную обратную связь'
      ],
      'Средний уровень': [
        'Участвуйте в групповых обсуждениях',
        'Развивайте навыки слушания',
        'Практикуйте ясное выражение мыслей'
      ],
      'Ниже среднего': [
        'Начните с простых разговоров',
        'Работайте над уверенностью в себе',
        'Практикуйте базовые навыки общения'
      ],
      'Низкий уровень': [
        'Развивайте базовые навыки общения',
        'Начните с простых ситуаций',
        'Ищите поддержку у психолога'
      ]
    },
    'Эмоциональный интеллект': {
      'Высокий уровень': [
        'Развивайте эмпатию',
        'Практикуйте осознанность',
        'Работайте над управлением стрессом'
      ],
      'Выше среднего': [
        'Развивайте эмоциональную осознанность',
        'Практикуйте саморегуляцию',
        'Работайте над пониманием эмоций других'
      ],
      'Средний уровень': [
        'Развивайте эмоциональную грамотность',
        'Практикуйте распознавание эмоций',
        'Работайте над выражением эмоций'
      ],
      'Ниже среднего': [
        'Начните с базового понимания эмоций',
        'Практикуйте простые техники саморегуляции',
        'Работайте над осознанием своих чувств'
      ],
      'Низкий уровень': [
        'Развивайте базовое понимание эмоций',
        'Начните с простых техник',
        'Ищите поддержку у психолога'
      ]
    },
    'Профессиональные предпочтения': {
      'Высокий уровень': [
        'Исследуйте новые профессиональные области',
        'Развивайте экспертизу в выбранной сфере',
        'Создавайте профессиональные связи'
      ],
      'Выше среднего': [
        'Изучайте смежные области',
        'Развивайте профессиональные навыки',
        'Ищите наставничество'
      ],
      'Средний уровень': [
        'Исследуйте разные профессии',
        'Развивайте базовые навыки',
        'Практикуйтесь в разных областях'
      ],
      'Ниже среднего': [
        'Начните с простых профессий',
        'Изучайте базовые требования',
        'Практикуйте простые навыки'
      ],
      'Низкий уровень': [
        'Развивайте базовые представления о профессиях',
        'Начните с простых задач',
        'Ищите профессиональную ориентацию'
      ]
    },
    'Личностные качества': {
      'Высокий уровень': [
        'Развивайте сильные стороны',
        'Работайте над слабыми местами',
        'Создавайте баланс между качествами'
      ],
      'Выше среднего': [
        'Развивайте ключевые качества',
        'Работайте над самосовершенствованием',
        'Практикуйте новые навыки'
      ],
      'Средний уровень': [
        'Развивайте основные качества',
        'Работайте над самопознанием',
        'Практикуйте новые подходы'
      ],
      'Ниже среднего': [
        'Начните с базовых качеств',
        'Работайте над уверенностью',
        'Практикуйте простые навыки'
      ],
      'Низкий уровень': [
        'Развивайте базовые качества',
        'Начните с простых задач',
        'Ищите поддержку у специалистов'
      ]
    }
  };

  return advice[category]?.[level] || [];
};

// Функция для получения подходящих профессий
const getProfessions = (category, level) => {
  const professions = {
    'Интеллектуальные способности': {
      'Высокий уровень': ['Ученый', 'Исследователь', 'Аналитик', 'Программист', 'Математик'],
      'Выше среднего': ['Инженер', 'Технолог', 'Архитектор', 'Финансист', 'Экономист'],
      'Средний уровень': ['Преподаватель', 'Консультант', 'Менеджер', 'Бухгалтер', 'Администратор'],
      'Ниже среднего': ['Оператор', 'Курьер', 'Кассир', 'Официант', 'Продавец'],
      'Низкий уровень': ['Рабочий', 'Грузчик', 'Уборщик', 'Охранник', 'Водитель']
    },
    'Коммуникативные навыки': {
      'Высокий уровень': ['Психолог', 'HR-менеджер', 'Журналист', 'PR-специалист', 'Тренер'],
      'Выше среднего': ['Менеджер по продажам', 'Консультант', 'Маркетолог', 'Учитель', 'Социальный работник'],
      'Средний уровень': ['Администратор', 'Офис-менеджер', 'Секретарь', 'Кассир', 'Оператор'],
      'Ниже среднего': ['Курьер', 'Водитель', 'Охранник', 'Уборщик', 'Грузчик'],
      'Низкий уровень': ['Рабочий', 'Грузчик', 'Уборщик', 'Охранник', 'Водитель']
    },
    'Эмоциональный интеллект': {
      'Высокий уровень': ['Психолог', 'Коуч', 'HR-менеджер', 'Социальный работник', 'Воспитатель'],
      'Выше среднего': ['Учитель', 'Менеджер', 'Консультант', 'Медсестра', 'Социальный педагог'],
      'Средний уровень': ['Администратор', 'Офис-менеджер', 'Секретарь', 'Кассир', 'Оператор'],
      'Ниже среднего': ['Курьер', 'Водитель', 'Охранник', 'Уборщик', 'Грузчик'],
      'Низкий уровень': ['Рабочий', 'Грузчик', 'Уборщик', 'Охранник', 'Водитель']
    },
    'Профессиональные предпочтения': {
      'Высокий уровень': ['Руководитель', 'Предприниматель', 'Эксперт', 'Консультант', 'Тренер'],
      'Выше среднего': ['Специалист', 'Менеджер', 'Координатор', 'Наставник', 'Консультант'],
      'Средний уровень': ['Сотрудник', 'Оператор', 'Администратор', 'Ассистент', 'Помощник'],
      'Ниже среднего': ['Рабочий', 'Оператор', 'Курьер', 'Охранник', 'Водитель'],
      'Низкий уровень': ['Рабочий', 'Грузчик', 'Уборщик', 'Охранник', 'Водитель']
    },
    'Личностные качества': {
      'Высокий уровень': ['Руководитель', 'Предприниматель', 'Эксперт', 'Консультант', 'Тренер'],
      'Выше среднего': ['Специалист', 'Менеджер', 'Координатор', 'Наставник', 'Консультант'],
      'Средний уровень': ['Сотрудник', 'Оператор', 'Администратор', 'Ассистент', 'Помощник'],
      'Ниже среднего': ['Рабочий', 'Оператор', 'Курьер', 'Охранник', 'Водитель'],
      'Низкий уровень': ['Рабочий', 'Грузчик', 'Уборщик', 'Охранник', 'Водитель']
    }
  };

  return professions[category]?.[level] || [];
};

// Функция для анализа результатов теста
const analyzeResults = (results) => {
  // Проверяем, что results существует и имеет правильную структуру
  if (!results || typeof results !== 'object') {
    throw new Error('Invalid results data structure');
  }

  // Проверяем наличие всех необходимых блоков
  const requiredBlocks = ['block1', 'block2', 'block3', 'block4', 'block5'];
  const missingBlocks = requiredBlocks.filter(block => !results[block]);
  
  if (missingBlocks.length > 0) {
    throw new Error(`Missing required blocks: ${missingBlocks.join(', ')}`);
  }

  const categories = {
    'Интеллектуальные способности': results.block1,
    'Коммуникативные навыки': results.block2,
    'Эмоциональный интеллект': results.block3,
    'Профессиональные предпочтения': results.block4,
    'Личностные качества': results.block5
  };

  const analysis = {};

  for (const [category, block] of Object.entries(categories)) {
    const score = calculateBlockScore(block);
    const level = determineLevel(score);
    const description = getLevelDescription(category, level);
    const professions = getProfessions(category, level);
    const advice = getAdvice(category, level);

    analysis[category] = {
      score,
      level,
      description,
      professions,
      advice
    };
  }

  return analysis;
};

const saveTestResults = async (req, res) => {
    try {
        const userId = req.user.id || req.user._id;
        const { block1, block2, block3, block4, block5 } = req.body;

        console.log('Received data:', {
            userId,
            block1,
            block2,
            block3,
            block4,
            block5
        });

        if (!userId) {
            return res.status(400).json({ message: 'User ID is required' });
        }

        const blocks = [block1, block2, block3, block4, block5];
        const emptyBlocks = blocks.filter(block => !block || Object.keys(block).length === 0);
        
        if (emptyBlocks.length > 0) {
            return res.status(400).json({ 
                message: 'All blocks must be filled',
                emptyBlocks: emptyBlocks.length
            });
        }

        const results = {
            userId,
            results: {
                block1,
                block2,
                block3,
                block4,
                block5
            },
            timestamp: new Date().toISOString()
        };

        // Загружаем текущие результаты
        const testResults = loadTestResults();
        
        // Добавляем новые результаты
        testResults.results.push(results);
        
        // Сохраняем обновленные результаты
        saveTestResultsToFile(testResults);

        const analysis = analyzeResults(results.results);

        res.json({
            success: true,
            message: 'Test results saved successfully',
            analysis
        });
    } catch (error) {
        console.error('Error saving test results:', error);
        res.status(500).json({ 
            message: 'Error saving test results',
            error: error.message 
        });
    }
};

const getTestResults = async (req, res) => {
    try {
        const { userId } = req.params;
        
        // Загружаем результаты из файла
        const testResults = loadTestResults();
        
        // Находим последние результаты пользователя
        const userResults = testResults.results
            .filter(result => result.userId === userId)
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
        
        if (!userResults) {
            return res.status(404).json({ message: 'Test results not found' });
        }

        console.log('Retrieved test result:', userResults);
        
        const analysis = analyzeResults(userResults.results);
        
        res.json({
            success: true,
            results: userResults,
            analysis
        });
    } catch (error) {
        console.error('Error getting test results:', error);
        res.status(500).json({ 
            message: 'Error getting test results',
            error: error.message 
        });
    }
};

module.exports = {
    saveTestResults,
    getTestResults
}; 