const fs = require('fs').promises;
const path = require('path');

const TEST_RESULTS_FILE = path.join(__dirname, '../../data/test_results.json');

class TestResult {
    constructor(userId, results) {
        this.userId = userId;
        this.results = results;
        this.timestamp = new Date().toISOString();
    }

    static async save(userId, results) {
        try {
            let allResults = [];
            try {
                const data = await fs.readFile(TEST_RESULTS_FILE, 'utf8');
                allResults = JSON.parse(data).results;
            } catch (error) {
                allResults = [];
            }

            const newResult = new TestResult(userId, results);
            allResults.push(newResult);
            
            await fs.writeFile(TEST_RESULTS_FILE, JSON.stringify({ results: allResults }, null, 2));
            return newResult;
        } catch (error) {
            throw new Error(`Error saving test results: ${error.message}`);
        }
    }

    static async getByUserId(userId) {
        try {
            const data = await fs.readFile(TEST_RESULTS_FILE, 'utf8');
            const allResults = JSON.parse(data).results;
            return allResults.find(result => result.userId === userId);
        } catch (error) {
            throw new Error(`Error getting test results: ${error.message}`);
        }
    }

    analyzeResults() {
        const analysis = {
            'ЧЕЛОВЕК – ТЕХНИКА': this.analyzeTechnical(),
            'ЧЕЛОВЕК – ПРИРОДА': this.analyzeNature(),
            'ЧЕЛОВЕК – ЧЕЛОВЕК': this.analyzePeople(),
            'ЧЕЛОВЕК – ЗНАКОВАЯ СИСТЕМА': this.analyzeSigns(),
            'ЧЕЛОВЕК – ХУДОЖЕСТВЕННЫЙ ОБРАЗ': this.analyzeArt(),
            'ЧЕЛОВЕК – ОРГАНИЗАЦИЯ': this.analyzeOrganization()
        };
        return analysis;
    }

    analyzeTechnical() {
        // Вопросы для анализа технического направления
        const technicalQuestions = {
            q1: 'Я люблю чинить, разбирать и собирать разные устройства.',
            q7: 'Мне нравится создавать программы или разрабатывать что-то в компьютере.',
            q9: 'Я с интересом провожу эксперименты и опыты.',
            q1: 'Я хорошо считаю и быстро нахожу логические решения.',
            q4: 'Я умею чинить поломки и работать руками.',
            q7: 'Я быстро осваиваю новые технологии.'
        };

        // Суммируем баллы за технические вопросы
        let totalScore = 0;
        for (const [key, value] of Object.entries(this.results.block1)) {
            if (technicalQuestions[key]) {
                totalScore += value;
            }
        }

        // Определяем уровень склонности
        let level = '';
        let description = '';
        let professions = [];
        let advice = [];

        if (totalScore >= 24) {
            level = 'Сильная склонность';
            description = 'Ты любишь всё, что связано с техникой, технологиями, устройствами, с интересом разбираешься в том, как всё работает, часто осваиваешь технику быстрее других, умеешь логически мыслить и решать практические задачи';
            professions = ['инженер', 'айтишник', 'программист', 'механик', 'архитектор', 'разработчик', 'строитель', 'робототехник', 'оператор ЧПУ', 'электрик'];
            advice = [
                'Пробуй работать с конструкторами, 3D-моделированием, программированием',
                'Ходи на кружки и мероприятия технической направленности',
                'Участвуй в олимпиадах по физике, информатике, математике',
                'Развивай навык решения практических задач (DIY, Arduino, сайты)'
            ];
        } else if (totalScore >= 18) {
            level = 'Умеренная склонность';
            description = 'Ты интересуешься техникой, но не всегда готов глубоко погружаться, можешь использовать технологии в повседневной жизни, предпочитаешь, когда всё чётко, понятно и логично';
            professions = ['специалист по IT-поддержке', 'веб-дизайнер', 'логист', 'техник', 'оператор', 'инженер-конструктор'];
            advice = [
                'Обрати внимание на профессии, где техника — помощник, а не смысл',
                'Поддерживай интерес через практику (например, сборка моделей, настройка гаджетов)'
            ];
        } else if (totalScore >= 12) {
            level = 'Слабая склонность';
            description = 'Ты предпочитаешь избегать сложной техники, можешь пользоваться устройствами, но не всегда хочешь вникать в детали, выбираешь более гуманитарные или творческие направления';
            advice = [
                'Не исключай технические навыки — базовые знания важны в любой сфере',
                'Используй технологии как инструмент, а не как цель (например, для съёмки, учёбы)'
            ];
        } else {
            level = 'Минимальная склонность';
            description = 'Ты почти не интересуешься техникой и технологиями, тебе ближе живое общение, природа, творчество, раздражают поломки, настройки, схемы';
            advice = [
                'Сфокусируйся на других направлениях',
                'Освой базовые навыки, чтобы уверенно пользоваться техникой в повседневной жизни'
            ];
        }

        return {
            score: totalScore,
            level,
            description,
            professions,
            advice
        };
    }

    analyzeNature() {
        const natureQuestions = {
            q2: 'Я люблю наблюдать за природой и животными.',
            q5: 'Мне нравится ухаживать за растениями и животными.',
            q8: 'Я интересуюсь экологией и защитой окружающей среды.',
            q3: 'Я люблю проводить время на свежем воздухе.',
            q6: 'Мне нравится изучать биологию и природные явления.',
            q9: 'Я забочусь о чистоте и сохранении природы.'
        };

        let totalScore = 0;
        for (const [key, value] of Object.entries(this.results.block1)) {
            if (natureQuestions[key]) {
                totalScore += value;
            }
        }

        let level = '';
        let description = '';
        let professions = [];
        let advice = [];

        if (totalScore >= 24) {
            level = 'Сильная склонность';
            description = 'Ты любишь природу, животных, растения, с интересом наблюдаешь за природными явлениями, заботишься об экологии, готов помогать и ухаживать за живыми существами';
            professions = ['ветеринар', 'эколог', 'биолог', 'агроном', 'лесничий', 'зоолог', 'ботаник', 'ландшафтный дизайнер', 'фермер', 'кинолог'];
            advice = [
                'Участвуй в экологических акциях и волонтерских программах',
                'Посещай кружки по биологии, экологии, ботанике',
                'Практикуйся в уходе за растениями и животными',
                'Изучай природные явления и экосистемы'
            ];
        } else if (totalScore >= 18) {
            level = 'Умеренная склонность';
            description = 'Ты интересуешься природой, но не всегда готов глубоко погружаться, ценишь чистоту и экологию, но не всегда активно участвуешь в защите природы';
            professions = ['ландшафтный дизайнер', 'флорист', 'эколог-консультант', 'специалист по экотуризму', 'биотехнолог'];
            advice = [
                'Развивай интерес через практику (уход за растениями, наблюдение за природой)',
                'Изучай экологические проблемы и способы их решения'
            ];
        } else if (totalScore >= 12) {
            level = 'Слабая склонность';
            description = 'Ты ценишь природу, но не всегда готов активно взаимодействовать с ней, предпочитаешь наблюдать со стороны';
            advice = [
                'Попробуй простые формы взаимодействия с природой (прогулки, фотография)',
                'Изучай базовые экологические принципы'
            ];
        } else {
            level = 'Минимальная склонность';
            description = 'Ты редко интересуешься природой, предпочитаешь городскую среду, не всегда замечаешь природные явления';
            advice = [
                'Сфокусируйся на других направлениях',
                'Попробуй найти минимальный контакт с природой, который тебе комфортен'
            ];
        }

        return {
            score: totalScore,
            level,
            description,
            professions,
            advice
        };
    }

    analyzePeople() {
        const peopleQuestions = {
            q1: 'Я люблю общаться с разными людьми.',
            q4: 'Мне нравится помогать другим и решать их проблемы.',
            q7: 'Я хорошо понимаю чувства и эмоции других людей.',
            q2: 'Я умею находить общий язык с разными людьми.',
            q5: 'Мне нравится работать в команде.',
            q8: 'Я умею слушать и давать советы.'
        };

        let totalScore = 0;
        for (const [key, value] of Object.entries(this.results.block1)) {
            if (peopleQuestions[key]) {
                totalScore += value;
            }
        }

        let level = '';
        let description = '';
        let professions = [];
        let advice = [];

        if (totalScore >= 24) {
            level = 'Сильная склонность';
            description = 'Ты любишь общаться с людьми, хорошо понимаешь их чувства, умеешь находить общий язык, готов помогать и поддерживать других';
            professions = ['психолог', 'учитель', 'врач', 'социальный работник', 'тренер', 'HR-специалист', 'журналист', 'менеджер по персоналу', 'консультант', 'коуч'];
            advice = [
                'Развивай навыки активного слушания и эмпатии',
                'Участвуй в волонтерских программах',
                'Практикуйся в решении конфликтов',
                'Изучай психологию общения'
            ];
        } else if (totalScore >= 18) {
            level = 'Умеренная склонность';
            description = 'Ты умеешь общаться с людьми, но не всегда готов глубоко погружаться в их проблемы, ценишь хорошие отношения, но не всегда активно их поддерживаешь';
            professions = ['менеджер по продажам', 'администратор', 'специалист по работе с клиентами', 'тьютор', 'социальный педагог'];
            advice = [
                'Развивай навыки коммуникации',
                'Учись лучше понимать других людей',
                'Практикуйся в решении конфликтов'
            ];
        } else if (totalScore >= 12) {
            level = 'Слабая склонность';
            description = 'Ты предпочитаешь ограниченный круг общения, не всегда готов активно взаимодействовать с незнакомыми людьми';
            advice = [
                'Развивай базовые навыки общения',
                'Попробуй найти комфортные формы взаимодействия с людьми'
            ];
        } else {
            level = 'Минимальная склонность';
            description = 'Ты предпочитаешь минимальное общение, ценишь уединение, не всегда готов к активному взаимодействию с людьми';
            advice = [
                'Сфокусируйся на других направлениях',
                'Развивай минимально необходимые навыки общения'
            ];
        }

        return {
            score: totalScore,
            level,
            description,
            professions,
            advice
        };
    }

    analyzeSigns() {
        const signsQuestions = {
            q3: 'Я люблю работать с числами и формулами.',
            q6: 'Мне нравится анализировать данные и статистику.',
            q9: 'Я хорошо разбираюсь в схемах и чертежах.',
            q1: 'Я умею систематизировать информацию.',
            q4: 'Мне нравится работать с документами.',
            q7: 'Я внимателен к деталям и точности.'
        };

        let totalScore = 0;
        for (const [key, value] of Object.entries(this.results.block1)) {
            if (signsQuestions[key]) {
                totalScore += value;
            }
        }

        let level = '';
        let description = '';
        let professions = [];
        let advice = [];

        if (totalScore >= 24) {
            level = 'Сильная склонность';
            description = 'Ты любишь работать с цифрами, схемами, документами, умеешь систематизировать информацию, внимателен к деталям и точности';
            professions = ['бухгалтер', 'аналитик', 'экономист', 'программист', 'статистик', 'архивариус', 'чертежник', 'финансист', 'логист', 'метролог'];
            advice = [
                'Развивай навыки работы с данными и документами',
                'Изучай математику и статистику',
                'Практикуйся в систематизации информации',
                'Участвуй в олимпиадах по математике и информатике'
            ];
        } else if (totalScore >= 18) {
            level = 'Умеренная склонность';
            description = 'Ты умеешь работать с цифрами и документами, но не всегда готов глубоко погружаться, ценишь порядок и системность';
            professions = ['офис-менеджер', 'специалист по кадрам', 'менеджер по логистике', 'специалист по документации', 'кассир'];
            advice = [
                'Развивай навыки работы с документами',
                'Изучай основы бухгалтерии и делопроизводства',
                'Практикуйся в систематизации информации'
            ];
        } else if (totalScore >= 12) {
            level = 'Слабая склонность';
            description = 'Ты предпочитаешь избегать работы с цифрами и документами, не всегда внимателен к деталям';
            advice = [
                'Развивай базовые навыки работы с документами',
                'Попробуй найти комфортные формы работы с информацией'
            ];
        } else {
            level = 'Минимальная склонность';
            description = 'Ты почти не интересуешься работой с цифрами и документами, предпочитаешь другие виды деятельности';
            advice = [
                'Сфокусируйся на других направлениях',
                'Освой минимально необходимые навыки работы с документами'
            ];
        }

        return {
            score: totalScore,
            level,
            description,
            professions,
            advice
        };
    }

    analyzeArt() {
        const artQuestions = {
            q2: 'Я люблю рисовать и создавать что-то своими руками.',
            q5: 'Мне нравится музыка и танцы.',
            q8: 'Я интересуюсь искусством и культурой.',
            q3: 'Я люблю выражать себя через творчество.',
            q6: 'Мне нравится фотографировать и снимать видео.',
            q9: 'Я умею видеть красоту в обычных вещах.'
        };

        let totalScore = 0;
        for (const [key, value] of Object.entries(this.results.block1)) {
            if (artQuestions[key]) {
                totalScore += value;
            }
        }

        let level = '';
        let description = '';
        let professions = [];
        let advice = [];

        if (totalScore >= 24) {
            level = 'Сильная склонность';
            description = 'Ты любишь творчество, искусство, умеешь видеть красоту, выражать себя через различные формы искусства';
            professions = ['художник', 'дизайнер', 'музыкант', 'актер', 'фотограф', 'архитектор', 'хореограф', 'режиссер', 'стилист', 'декоратор'];
            advice = [
                'Развивай творческие навыки через практику',
                'Посещай выставки, концерты, спектакли',
                'Изучай историю искусства и культуры',
                'Пробуй разные формы творческого самовыражения'
            ];
        } else if (totalScore >= 18) {
            level = 'Умеренная склонность';
            description = 'Ты интересуешься искусством, но не всегда готов активно заниматься творчеством, ценишь красоту и культуру';
            professions = ['дизайнер интерьера', 'фотограф', 'стилист', 'арт-директор', 'креативный менеджер'];
            advice = [
                'Развивай творческие навыки через хобби',
                'Изучай основы дизайна и искусства',
                'Практикуйся в разных формах творчества'
            ];
        } else if (totalScore >= 12) {
            level = 'Слабая склонность';
            description = 'Ты иногда интересуешься искусством, но не всегда готов активно заниматься творчеством';
            advice = [
                'Попробуй простые формы творчества',
                'Изучай основы искусства и дизайна'
            ];
        } else {
            level = 'Минимальная склонность';
            description = 'Ты почти не интересуешься искусством и творчеством, предпочитаешь другие виды деятельности';
            advice = [
                'Сфокусируйся на других направлениях',
                'Попробуй найти минимальный контакт с искусством, который тебе комфортен'
            ];
        }

        return {
            score: totalScore,
            level,
            description,
            professions,
            advice
        };
    }

    analyzeOrganization() {
        const organizationQuestions = {
            q1: 'Я люблю планировать и организовывать.',
            q4: 'Мне нравится руководить и принимать решения.',
            q7: 'Я умею распределять задачи и контролировать их выполнение.',
            q2: 'Я хорошо работаю в условиях неопределенности.',
            q5: 'Мне нравится брать на себя ответственность.',
            q8: 'Я умею мотивировать других.'
        };

        let totalScore = 0;
        for (const [key, value] of Object.entries(this.results.block1)) {
            if (organizationQuestions[key]) {
                totalScore += value;
            }
        }

        let level = '';
        let description = '';
        let professions = [];
        let advice = [];

        if (totalScore >= 24) {
            level = 'Сильная склонность';
            description = 'Ты любишь организовывать и руководить, умеешь принимать решения, распределять задачи, мотивировать других';
            professions = ['менеджер', 'руководитель', 'предприниматель', 'проектный менеджер', 'директор', 'координатор', 'администратор', 'организатор мероприятий', 'HR-директор', 'бизнес-консультант'];
            advice = [
                'Развивай лидерские качества',
                'Изучай основы менеджмента и управления',
                'Практикуйся в организации мероприятий',
                'Участвуй в управленческих проектах'
            ];
        } else if (totalScore >= 18) {
            level = 'Умеренная склонность';
            description = 'Ты умеешь организовывать и руководить, но не всегда готов брать на себя большую ответственность';
            professions = ['менеджер проекта', 'руководитель отдела', 'координатор', 'администратор', 'организатор'];
            advice = [
                'Развивай организационные навыки',
                'Изучай основы управления',
                'Практикуйся в организации небольших проектов'
            ];
        } else if (totalScore >= 12) {
            level = 'Слабая склонность';
            description = 'Ты предпочитаешь работать в команде, не всегда готов брать на себя руководящие функции';
            advice = [
                'Развивай базовые организационные навыки',
                'Попробуй организовать небольшое мероприятие'
            ];
        } else {
            level = 'Минимальная склонность';
            description = 'Ты предпочитаешь работать под руководством других, не всегда готов брать на себя ответственность';
            advice = [
                'Сфокусируйся на других направлениях',
                'Развивай минимально необходимые организационные навыки'
            ];
        }

        return {
            score: totalScore,
            level,
            description,
            professions,
            advice
        };
    }
}

module.exports = TestResult; 